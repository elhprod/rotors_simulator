<?xml version="1.0"?>

<robot xmlns:xacro="http://ros.org/wiki/xacro">

    <xacro:include filename="$(find rotors_description)/urdf/multirotor_base.xacro"/>

    <xacro:macro name="soliro_base_macro"
                 params="robot_namespace mass body_width body_height use_mesh_file mesh_file collision_mesh_file *origin *inertia *inertia_origin">
        <link name="${robot_namespace}/base_link"></link>

        <joint name="${robot_namespace}/base_joint" type="fixed">
            <xacro:insert_block name="origin" />
            <parent link="${robot_namespace}/base_link" />
            <child link="${robot_namespace}/base_link_inertia" />
        </joint>

        <link name="${robot_namespace}/base_link_inertia">
            <inertial>
                <mass value="${mass}" />  <!-- [kg] -->
                <xacro:insert_block name="inertia_origin" />
                <xacro:insert_block name="inertia" />
            </inertial>

            <visual>
                <origin xyz="0 0 0" rpy="0 0 0" />
                <geometry>
                    <xacro:if value="${use_mesh_file}">
                        <mesh filename="${mesh_file}" scale="1 1 1" />
                    </xacro:if>
                    <xacro:unless value="${use_mesh_file}">
                        <box size="${body_width} ${body_width} ${body_height}"/> <!-- [m] [m] [m] -->
                    </xacro:unless>
                </geometry>
            </visual>

            <collision>
                <origin xyz="0 0 0" rpy="0 0 0" />
                <geometry>
                    <xacro:if value="${use_mesh_file}">
                        <mesh filename="${collision_mesh_file}" scale="1 1 1" />
                    </xacro:if>
                    <xacro:unless value="${use_mesh_file}">
                        <box size="${body_width} ${body_width} ${body_height}"/> <!-- [m] [m] [m] -->
                    </xacro:unless>
                </geometry>
            </collision>

            <surface>
                <friction>
                    <ode>
                        <mu>0.5</mu>
                        <mu2>0.5</mu2>
                    </ode>
                </friction>
                <bounce>
                    <restitution_coefficient>0.01</restitution_coefficient>
                    <threshold>0.01</threshold>
                </bounce>
                <contact>
                    <ode>
                        <max_vel>0.1</max_vel>
                        <soft_cfm>0.8</soft_cfm>
                        <soft_erp>0.8</soft_erp>
                        <kd>2500</kd>
                        <kp>10</kp>
                        <min_depth>0.001</min_depth>
                    </ode>
                </contact>
            </surface>
        </link>

        <!-- attach multirotor_base_plugin to the base_link -->
        <gazebo>
            <plugin filename="librotors_gazebo_multirotor_base_plugin.so" name="multirotor_base_plugin">
                <robotNamespace>${robot_namespace}</robotNamespace>
                <linkName>${robot_namespace}/base_link</linkName>
                <rotorVelocitySlowdownSim>${rotor_velocity_slowdown_sim}</rotorVelocitySlowdownSim>
            </plugin>
        </gazebo>
    </xacro:macro>

    <!-- Tilting wing unit link and joint. -->
    <xacro:macro name="wing_unit"
                 params="robot_namespace direction parent mass_rotor mass_tilt_unit rotor_offset_top wing_number color mesh mesh_tilt_wing *origin *inertia">

        <!-- Wing -->
        <joint name="${robot_namespace}/tilt_wing_servo_${wing_number}" type="continuous">
            <origin xyz="0 -0.37 0" rpy="0 0 ${pi}"/>
            <axis xyz="0 1 0" />
            <parent link="${parent}" />
            <child link="${namespace}/tilt_wing_${wing_number}" />
        </joint>

        <gazebo reference="${robot_namespace}/tilt_wing_servo_${wing_number}_revolutejoint">
            <provideFeedback>true</provideFeedback>
        </gazebo>

        <link name="${namespace}/tilt_wing_${wing_number}">
            <inertial>
                <mass value="${mass_tilt_unit}" /> <!-- [kg] -->
                <xacro:insert_block name="tilt_unit_inertia" />
            </inertial>
            <visual>
                <geometry>
                    <mesh filename="${mesh_tilt_wing}"
                          scale="0.001 0.001 0.001" />
                </geometry>
            </visual>
            <collision>
                <geometry>
                    <box size="0.005 0.005 0.005"  /> <!-- [m] -->
                </geometry>
            </collision>
        </link>

        <gazebo reference="${namespace}/tilt_wing_${wing_number}">
            <material>Gazebo/White</material>
        </gazebo>

        <!-- Motor tilt mechanism -->
        <joint name="${robot_namespace}/motor_tilt_mechanism_servo_${wing_number}" type="revolute">
            <origin xyz="0 0 0" rpy="0 ${pi/2} 0"/>
            <axis xyz="0 0 1" />
            <!-- TODO check effort and velocity -->
            <limit lower="-${pi}" upper="${pi}" effort="0" velocity="0" />
            <parent link="${namespace}/tilt_wing_${wing_number}" />
            <child link="${namespace}/motor_tilt_mechanism_${wing_number}" />
        </joint>

        <gazebo reference="${robot_namespace}/motor_tilt_mechanism_servo_${wing_number}_revolutejoint">
            <provideFeedback>true</provideFeedback>
        </gazebo>

        <link name="${namespace}/motor_tilt_mechanism_${wing_number}">
            <inertial>
                <mass value="${mass_tilt_unit}" /> <!-- [kg] -->
                <xacro:insert_block name="tilt_unit_inertia" />
            </inertial>
            <visual>
                <geometry>
                    <mesh filename="${mesh_file_right_motor}"
                          scale="1 1 1" />
                </geometry>
            </visual>
            <collision>
                <geometry>
                    <box size="0.005 0.005 0.005"  /> <!-- [m] -->
                </geometry>
            </collision>
        </link>

        <gazebo reference="${namespace}/tilt_wing_${wing_number}">
            <material>Gazebo/White</material>
        </gazebo>

        <!-- Rotor -->
        <joint name="rotor_${wing_number}_joint" type="continuous">
            <origin xyz="0.1 0 0" rpy="0 0 0"/>
            <axis xyz="1 0 0"/>
            <parent link="${namespace}/motor_tilt_mechanism_${wing_number}"/>
            <child link="rotor_${wing_number}"/>
        </joint>

        <link name="rotor_${wing_number}">
            <inertial>
                <mass value="${mass_rotor}"/>  <!-- [kg] -->
                <xacro:insert_block name="inertia"/>
            </inertial>
            <visual>
                <geometry>
                    <mesh filename="package://rotors_description/meshes/soliro/propeller.stl"
                          scale="1 1 1" />
                </geometry>
            </visual>
            <collision>
                <geometry>
                    <cylinder length="0.005" radius="${radius_rotor}" /> --> <!-- [m] -->
                </geometry>
            </collision>
        </link>

        <gazebo reference="rotor_${wing_number}">
            <material>Gazebo/${color}</material>
        </gazebo>

    </xacro:macro>


</robot>